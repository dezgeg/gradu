\section{Johdanto}

\section{POSIX-tiedostojärjestelmärajapinnat}

Aikoinaan oli käytössä useita Unix-pohjaisia käyttöjärjestelmiä jotka olivat periaatteessa samankaltaisia mutta käytännössä toimivat hieman eri tavalla.
Sovellusohjelmoijan kannalta tämä hankaloitti huomattavasti monella eri Unix-järjestelmällä toivivien ohjelmien toteutusta.
Tämän ratkaisemiseksi kehiteltiin POSIX-standardi~\ref{PosixSpec} yhtenäistämään eri Unix-toteutusten tarjoamat rajapinnat.
Ensimmäinen versio standardista julkaistiin vuonna 1988.
POSIX-standardi määrittelee muun muassa komentorivityökaluja sekä C-kielisiä rajapintoja muun muassa tiedostojen, säikeiden ja prosessien hallintaan.
Käytännössä mitään Linux-jakelua ei virallisesti ole sertifioitu POSIX-yhteensopivaksi,
mutta käytännössä kehittäjät tähtäävät POSIX-yhteensopivuuteen.

Luotettavien ja kaatumisen kestävien sovellusten luominen POSIXissa on suhteellisen monimutkaista.
Esitelläänkin seuraavaksi POSIXin tarjoamat C-rajapinnat tiedostojen käsittelyyn.

\subsection{Tiedostonimet}
POSIX-tiedostojärjestelmät tukevat hakemistoja, eli tiedostojärjestelmä muodostaa hierarkisen puurakenteen.
Tiedostopoluissa hakemistojen erottimena toimii kauttaviiva eli \texttt{/}-merkki.
\texttt{/}-merkillä alkavat tiedostopolut ovat \emph{absoluuttisia} polkuja,
muut polut ovat \emph{suhteellisia} polkuja.
Jokaisella ajonaikaisella prosessilla on oma nykyinen hakemistonsa (current directory),
jonka suhteen suhteelliset polut tulkitaan.
Esimerkiksi prosessilla jonka nykyinen hakemisto on \texttt{/home/tuomas},
viittaisi polku \texttt{Downloads/kuva.jpg} tiedostoon \texttt{/home/tuomas/Downloads/kuva.jpg}.
POSIXissa on kaksi erityistä tiedostonimeä: \texttt{.} ja \texttt{..} joiden voidaan mieltää löytyvän jokaisesta hakemistosta.
Näistä \texttt{.} viittaa aina siihen hakemistoon jossa se sijaitsee,
esimerkiksi polku \texttt{/home/tuomas/.} viittaa samaan hakemistoon kuin polku \texttt{/home/tuomas}.
Niinikään \texttt{.}-nimeä voi käyttää missä tahansa kohtaa polkua,
eli esimerkiksi \texttt{/home/./tuomas} tai \texttt{/home/././tuomas/././.} viittaavat edelleen samaan hakemistoon.
Nimi \texttt{..} taas viittaa ylempään tasoon hakemistorakenteessa.

\subsection{Tiedoston avaus ja sulkeminen}
Tiedoston avaus tapahtuu \texttt{open}-funktiolla:

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/open.html#tag_16_357
\begin{verbatim}
int open(const char *path, int oflag, ...);
\end{verbatim}

Parametri \texttt{path} on tiedoston polku merkkijonona
ja \texttt{oflag} on kasa lippuja jotka määräävät miten tiedosto avataan.
Yksi lipuista \texttt{O\_RDONLY}, \texttt{O\_WRONLY} ja \texttt{O\_RDWR} on pakko antaa.
Ne määräävät avataanko tiedosto vain lukua, vain kirjoitusta tai sekä lukua että
kirjoitusta varten.
Muita mahdollisia lippuja on esimerkiksi \texttt{O\_TRUNC},
joka tyhjentään tiedoston sisällön (truncate).
Tiedoston voi myös luoda antamalla lipun \texttt{O\_CREAT},
jolloin kolmas parametri määrittelee luodun tiedoston oikeudet.
Funktio palauttaa onnistuessaan \texttt{int}-tyyppisen \emph{tiedostokahvan},
joka viittaa kyseiseen avattuun tiedostoon.
Tiedostokahvat ovat prosessikohtaisia,
eli yrittämällä lukea samalla tiedostokahvan numeerisella arvolla
jossakin toisessa prosessissa tapahtuu jotain odottomatonta.

Tiedoston sulkeminen tapahtuu \texttt{close}-funktiolla,
jolle annetaan auki oleva tiedostokahva ainoana parametrina:

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/close.html#tag_16_67
\begin{verbatim}
int close(int fildes);
\end{verbatim}

\subsection{Tiedoston luku ja kirjoitus}

Tiedostosta luku ja tiedostoon kirjoitus tapahtuu ohjelmoijan näkökulmasta suhteellisen
samalla tavalla, funktioilla \texttt{read} ja \texttt{write}:

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/read.html#tag_16_474
% http://pubs.opengroup.org/onlinepubs/9699919799/functions/write.html#tag_16_685
\begin{verbatim}
ssize_t read(int fildes, void *buf, size_t nbyte);
ssize_t write(int fildes, const void *buf, size_t nbyte);
\end{verbatim}

Ensimmäinen parametri \texttt{fildes} on tiedostokahva jota operoidaan.
\texttt{buf} on osoitin \texttt{nbyte} tavun kokoiseen puskuriin johon
luetaan tai josta kirjoitetaan.
Onnistuessaan funktiot palauttavat kuinka monta tavua luettiin tai kirjoitettiin.
Paluuarvo voi siis olla pienempi kuin mitä ohjelma pyysi lukemaan tai kirjoittamaan,
esimerkiksi jos kirjoittaessa levy täyttyi kesken tai luettaessa
tiedosto loppui kesken.

Jokaisella tavalliseen tiedostoon viittaavalla tiedostokahvalla on
sijainti tavuina missä kohtaa tiedostoa ollaan ja josta
lukeminen tai kirjoittaminen aloitetaan.
Onnistuessaan sijainti tiedostossa siirtyy eteenpäin paluuarvon verran.

Tiedostokahvan sijainnin voi selvittää ja sijaintia tiedostossa voi
siirtää \texttt{lseek}-kutsulla:

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/lseek.html#tag_16_310
\begin{verbatim}
off_t lseek(int fildes, off_t offset, int whence);
\end{verbatim}

Ensimmäinen parametri \texttt{fildes} on tiedostokahva jota operoidaan.
Kolmas parametri \texttt{whence} kertoo miten \texttt{offset}-parametri tulkitaan:

\begin{itemize}
    \item Arvo \texttt{SEEK\_SET} asettaa kahvan sijainniksi \texttt{offset}.
    \item Arvo \texttt{SEEK\_CUR} siirtää kahvaa eteenpäin \texttt{offset} tavua.
    \item Arvo \texttt{SEEK\_END} siirtää kahvan \texttt{offset} tavua eteenpäin laskien tiedoston lopusta.
\end{itemize}

Onnistuessaan kutsu palauttaa sijainnin johon siirryttiin.
Sijainnin voi siis selvittää siirtymättä tiedostossa kutsulla \texttt{lseek(fd, , SEEK\_CUR)}.

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/fstat.html#tag_16_173
\begin{verbatim}
int fstat(int fildes, struct stat *buf);
\end{verbatim}

% dev_t st_dev            Device ID of device containing file
% ino_t st_ino            File serial number.
% mode_t st_mode          Mode of file (see below).
% nlink_t st_nlink        Number of hard links to the file.
% uid_t st_uid            User ID of file.
% gid_t st_gid            Group ID of file.
% dev_t st_rdev           Device ID (if file is character or block special).
% off_t st_size           For regular files, the file size in bytes.
%                         For symbolic links, the length in bytes of the
%                         pathname contained in the symbolic link.
% struct timespec st_atim Last data access timestamp.
% struct timespec st_mtim Last data modification timestamp.
% struct timespec st_ctim Last file status change timestamp.
% blksize_t st_blksize    A file system-specific preferred I/O block size
%                         for this object. In some file system types, this
%                         may vary from file to file.
% blkcnt_t st_blocks      Number of blocks allocated for this object.
%
% http://pubs.opengroup.org/onlinepubs/9699919799/functions/chmod.html#tag_16_58
\begin{verbatim}
int chmod(const char *path, mode_t mode);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/chown.html#tag_16_59
\begin{verbatim}
int chown(const char *path, uid_t owner, gid_t group);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/link.html#tag_16_293
\begin{verbatim}
int link(const char *path1, const char *path2);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/unlink.html#tag_16_635
\begin{verbatim}
int unlink(const char *path);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/rename.html#tag_16_487
\begin{verbatim}
int rename(const char *old, const char *new);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/readdir.html#tag_16_475
\begin{verbatim}
struct dirent *readdir(DIR *dirp);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/readlink.html#tag_16_476
\begin{verbatim}
ssize_t readlink(const char *restrict path, char *restrict buf, size_t bufsize);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/ftruncate.html
\begin{verbatim}
int ftruncate(int fildes, off_t length);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/fdopendir.html#tag_16_127
\begin{verbatim}
DIR *opendir(const char *dirname);
\end{verbatim}

% http://pubs.opengroup.org/onlinepubs/9699919799/functions/closedir.html
\begin{verbatim}
int closedir(DIR *dirp);
\end{verbatim}

\section{ext2:n rakenne}
ext2 (``Second extended filesystem'')  on tiedostojärjestelmä joka on luotu jo Linuxin alkuaikoina, vuonna 1993.
Ennen ext2:ta Linux käytti MINIX-tiedostojärjestelmää,
joka oli yksinkertainen mutta sisälsi erinäisiä rajoitteita jotka alkoivat haittaamaan.
Esimerkiksi MINIX-tiedostojärjestelmässä tiedostonimen pituus oli rajoitettu 14 merkkiin
ja tiedoston koko 64 megatavuun.
Ext2 ei ainoastaan korjaa näitä puutteeita,
mutta on lisäksi suunniteltu siten että tiedostojärjelmän levyformaattia voidaan laajentaa taaksepäin yhteensopivasti.
Ext2:lle onkin kehitetty seuraajat ext3 ja ext4 joissa olemassaoleva ext2- tai ext3-osio voidaan päivittää seuraavaan
ext:n versioon ilman tiedostojärjestelmän uudelleenformatointia.

Tässä luvussa tarkastellaan ext2:n rakennetta levyllä.

\section{Yhteenveto}
